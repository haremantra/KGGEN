"""Tests for src/risk/rules.py and src/risk/assessor.py â€” Risk scoring logic.\n\nimport pytest\nfrom src.risk.rules import (\n    RiskSeverity, RiskRule, RISK_RULES, MISSING_CLAUSE_RISKS,\n    get_rule_for_label, get_missing_clause_rule,\n    get_high_risk_labels, get_labels_requiring_llm,\n)\nfrom src.risk.assessor import (\n    RiskAssessor, RiskAssessment, RiskFinding, SEVERITY_WEIGHTS,\n)\n\nclass TestRiskSeverityEnum:\n\n    def test_count(self):\n        assert len(RiskSeverity) == 5\n\n    def test_values(self):\n        values = {s.value for s in RiskSeverity}\n        assert values == {"CRITICAL", "HIGH", "MEDIUM", "LOW", "INFO"}\n\n\nclass TestRiskRules:\n\n    def test_count(self):\n        assert len(RISK_RULES) == 40\n\n    def test_all_have_reason(self):\n        for label, rule in RISK_RULES.items():\n            assert rule.reason, f"{label} has empty reason"\n\n    def test_all_have_recommendation(self):\n        for label, rule in RISK_RULES.items():\n            assert rule.recommendation, f"{label} has empty recommendation"\n\n    def test_all_have_valid_severity(self):\n        for label, rule in RISK_RULES.items():\n            assert isinstance(rule.severity, RiskSeverity), f"{label} has invalid severity"\n\n\nclass TestMissingClauseRisks:\n\n    def test_count(self):\n        assert len(MISSING_CLAUSE_RISKS) == 8\n\n    def test_cap_on_liability_is_critical(self):\n        rule = MISSING_CLAUSE_RISKS["Cap On Liability"]\n        assert rule.severity == RiskSeverity.CRITICAL\n\n\nclass TestHelperFunctions:\n\n    def test_get_rule_for_label_exists(self):\n        rule = get_rule_for_label("Exclusivity")\n        assert rule is not None\n        assert rule.severity == RiskSeverity.CRITICAL\n\n    def test_get_rule_for_label_missing(self):\n        assert get_rule_for_label("FakeLabel") is None\n\n    def test_get_missing_clause_rule_exists(self):\n        rule = get_missing_clause_rule("Cap On Liability")\n        assert rule is not None\n        assert rule.severity == RiskSeverity.CRITICAL\n\n    def test_get_missing_clause_rule_missing(self):\n        assert get_missing_clause_rule("FakeLabel") is None\n\n    def test_get_high_risk_labels(self):\n        labels = get_high_risk_labels()\n        assert len(labels) > 0\n        for label in labels:\n            rule = RISK_RULES[label]\n            assert rule.severity in (RiskSeverity.HIGH, RiskSeverity.CRITICAL)\n\n    def test_get_labels_requiring_llm(self):\n        labels = get_labels_requiring_llm()\n        assert len(labels) == 11\n        for label in labels:\n            assert RISK_RULES[label].requires_llm is True\n\n\nclass TestSeverityWeights:\n\n    def test_critical(self):\n        assert SEVERITY_WEIGHTS[RiskSeverity.CRITICAL] == 25\n\n    def test_high(self):\n        assert SEVERITY_WEIGHTS[RiskSeverity.HIGH] == 15\n\n    def test_medium(self):\n        assert SEVERITY_WEIGHTS[RiskSeverity.MEDIUM] == 8\n\n    def test_low(self):\n        assert SEVERITY_WEIGHTS[RiskSeverity.LOW] == 3\n\n    def test_info(self):\n        assert SEVERITY_WEIGHTS[RiskSeverity.INFO] == 0\n\n\nclass TestRiskAssessor:\n\n    def test_score_to_level_low(self):\n        assessor = RiskAssessor(use_llm=False)\n        assert assessor._score_to_level(0) == "LOW"\n        assert assessor._score_to_level(24) == "LOW"\n\n    def test_score_to_level_medium(self):\n        assessor = RiskAssessor(use_llm=False)\n        assert assessor._score_to_level(25) == "MEDIUM"\n        assert assessor._score_to_level(49) == "MEDIUM"\n\n    def test_score_to_level_high(self):\n        assessor = RiskAssessor(use_llm=False)\n        assert assessor._score_to_level(50) == "HIGH"\n        assert assessor._score_to_level(74) == "HIGH"\n\n    def test_score_to_level_critical(self):\n        assessor = RiskAssessor(use_llm=False)\n        assert assessor._score_to_level(75) == "CRITICAL"\n        assert assessor._score_to_level(100) == "CRITICAL"\n\n    def test_calculate_risk_score_empty(self):\n        assessor = RiskAssessor(use_llm=False)\n        assert assessor._calculate_risk_score([], []) == 0\n\n    def test_calculate_risk_score_capped_at_100(self):\n        assessor = RiskAssessor(use_llm=False)\n        many_findings = [\n            RiskFinding(label=f"l{i}", severity=RiskSeverity.CRITICAL,\n                        reason="r", recommendation="rec", confidence=1.0)\n            for i in range(50)\n        ]\n        score = assessor._calculate_risk_score(many_findings, [])\n        assert score <= 100\n\n    def test_assess_no_llm(self, sample_contract_analysis):\n        assessor = RiskAssessor(use_llm=False)\n        result = assessor.assess(sample_contract_analysis)\n        assert isinstance(result, RiskAssessment)\n        assert 0 <= result.overall_risk_score <= 100\n        assert result.risk_level in ("LOW", "MEDIUM", "HIGH", "CRITICAL")\n        assert result.contract_id == "test-contract-001"\n\n    def test_assess_finds_present_clause_risks(self, sample_contract_analysis):\n        assessor = RiskAssessor(use_llm=False)\n        result = assessor.assess(sample_contract_analysis)\n        labels = {f.label for f in result.findings}\n        assert "License Grant" in labels or "Cap On Liability" in labels\n\n    def test_assess_finds_missing_clauses(self, sample_contract_analysis):\n        assessor = RiskAssessor(use_llm=False)\n        result = assessor.assess(sample_contract_analysis)\n        missing_labels = {f.label for f in result.missing_clause_risks}\n        # Contract has Cap On Liability so it shouldn't be missing\n        assert "Cap On Liability" not in missing_labels\n\n\nclass TestSerialization:\n\n    def test_risk_finding_to_dict(self):\n        f = RiskFinding(label="Test", severity=RiskSeverity.HIGH,\n                        reason="Reason", recommendation="Rec",\n                        clause_text="clause", confidence=0.9, source="rule")\n        d = f.to_dict()\n        assert d["label"] == "Test"\n        assert d["severity"] == "HIGH"\n        assert d["source"] == "rule"\n\n    def test_risk_assessment_to_dict(self, sample_risk_assessment):\n        d = sample_risk_assessment.to_dict()\n        assert d["contract_id"] == "test-contract-001"\n        assert d["overall_risk_score"] == 45\n        assert isinstance(d["findings"], list)\n"""